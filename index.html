<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#ffd7f2" />
  <title>HASTA EL PUSSY</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&family=Poppins:wght@400;600;800&family=Pacifico&display=swap" rel="stylesheet">

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    .font-poppins { font-family: "Poppins", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .font-nunito { font-family: "Nunito", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .font-pacifico { font-family: "Pacifico", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    input, textarea, select { font-size: 16px; }
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-thumb { background: rgba(0,0,0,.12); border-radius: 999px; }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-b from-pink-100 via-rose-50 to-amber-50 text-slate-800 font-nunito">
  <div class="max-w-md mx-auto min-h-screen flex flex-col">

    <!-- Header -->
    <div class="px-4 pt-5 pb-3">
      <div class="rounded-3xl bg-white/70 backdrop-blur shadow-sm border border-white/60 px-4 py-3">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-fuchsia-400 to-rose-400 flex items-center justify-center shadow-sm">
              <span class="text-white text-lg">üíñ</span>
            </div>
            <div class="text-base font-extrabold tracking-tight">HASTA EL PUSSY</div>
          </div>
          <button id="btnSettings" class="hidden px-3 py-2 rounded-2xl bg-white shadow-sm border border-slate-100 active:scale-[0.98]">‚öôÔ∏è</button>
        </div>
      </div>
    </div>

    <!-- AUTH -->
    <div id="authView" class="px-4 pb-6 flex-1">
      <div class="rounded-3xl bg-white/80 backdrop-blur shadow-sm border border-white/60 p-4">
        <div class="grid grid-cols-2 gap-2 mb-3">
          <button id="tabLogin" class="px-3 py-2 rounded-2xl font-extrabold bg-gradient-to-r from-rose-400 to-fuchsia-400 text-white shadow-sm active:scale-[0.98]">Login</button>
          <button id="tabRegister" class="px-3 py-2 rounded-2xl font-extrabold bg-white border border-slate-100 shadow-sm active:scale-[0.98]">Registro</button>
        </div>

        <div class="space-y-3">
          <div>
            <label class="text-xs font-extrabold text-slate-600">Usuaria</label>
            <input id="authUsername" class="mt-1 w-full px-4 py-3 rounded-2xl bg-white border border-slate-100 shadow-sm outline-none focus:ring-2 focus:ring-rose-200" placeholder="marta / laura / etc" autocomplete="username" />
          </div>

          <div>
            <label class="text-xs font-extrabold text-slate-600">Contrase√±a</label>
            <input id="authPassword" type="password" class="mt-1 w-full px-4 py-3 rounded-2xl bg-white border border-slate-100 shadow-sm outline-none focus:ring-2 focus:ring-rose-200" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
          </div>

          <div id="registerExtras" class="hidden space-y-3">
            <div>
              <label class="text-xs font-extrabold text-slate-600">Nombre</label>
              <input id="authDisplayName" class="mt-1 w-full px-4 py-3 rounded-2xl bg-white border border-slate-100 shadow-sm outline-none focus:ring-2 focus:ring-rose-200" placeholder="Marta üíÉ" autocomplete="name" />
            </div>

            <div>
              <label class="text-xs font-extrabold text-slate-600">Avatar</label>
              <input id="authAvatar" type="file" accept="image/*" class="mt-1 w-full px-4 py-3 rounded-2xl bg-white border border-slate-100 shadow-sm outline-none focus:ring-2 focus:ring-rose-200" />
            </div>
          </div>

          <button id="btnAuthAction" class="w-full px-4 py-3 rounded-2xl font-extrabold bg-gradient-to-r from-rose-400 to-fuchsia-400 text-white shadow-sm active:scale-[0.98]">Entrar</button>
          <div id="authError" class="hidden rounded-2xl bg-red-50 border border-red-100 p-3 text-sm font-bold text-red-700"></div>
        </div>
      </div>
    </div>

    <!-- APP -->
    <div id="appView" class="hidden flex-1 px-4 pb-28">
      <div class="rounded-3xl bg-white/80 backdrop-blur shadow-sm border border-white/60 p-4">
        <div class="flex items-center justify-between">
          <button id="btnPrevMonth" class="px-3 py-2 rounded-2xl bg-white border border-slate-100 shadow-sm active:scale-[0.98]">‚óÄ</button>
          <div class="text-center">
            <div id="monthTitle" class="text-lg font-black"></div>
          </div>
          <button id="btnNextMonth" class="px-3 py-2 rounded-2xl bg-white border border-slate-100 shadow-sm active:scale-[0.98]">‚ñ∂</button>
        </div>

        <div class="mt-4 grid grid-cols-7 gap-2 text-[11px] font-extrabold text-slate-500">
          <div class="text-center">L</div><div class="text-center">M</div><div class="text-center">X</div>
          <div class="text-center">J</div><div class="text-center">V</div><div class="text-center">S</div><div class="text-center">D</div>
        </div>

        <div id="calendarGrid" class="mt-2 grid grid-cols-7 gap-2"></div>
      </div>

      <div class="mt-3 flex gap-2">
        <button id="btnToday" class="flex-1 px-4 py-2 rounded-2xl bg-white/80 border border-white/60 shadow-sm font-extrabold active:scale-[0.98]">üìç Hoy</button>
        <div id="adminBadge" class="hidden px-4 py-2 rounded-2xl bg-gradient-to-r from-amber-400 to-rose-400 text-white shadow-sm font-extrabold">üëë ADMIN</div>
      </div>
    </div>

    <!-- Bottom bar -->
    <div id="bottomBar" class="hidden fixed bottom-0 left-0 right-0">
      <div class="max-w-md mx-auto px-4 pb-4">
        <div class="rounded-3xl bg-white/90 backdrop-blur shadow-lg border border-white/60 p-3 flex items-center justify-between">
          <button id="btnOpenProfile" class="flex items-center gap-2 px-3 py-2 rounded-2xl bg-white border border-slate-100 shadow-sm active:scale-[0.98]">
            <span id="meAvatarMini" class="w-7 h-7 rounded-2xl bg-slate-200 overflow-hidden flex items-center justify-center">üôÇ</span>
            <span id="meNameMini" class="text-sm font-extrabold"></span>
          </button>
          <button id="btnQuickAdd" class="px-4 py-2 rounded-2xl font-extrabold bg-gradient-to-r from-rose-400 to-fuchsia-400 text-white shadow-sm active:scale-[0.98]">‚ûï Evento</button>
          <button id="btnLogout" class="px-3 py-2 rounded-2xl bg-white border border-slate-100 shadow-sm active:scale-[0.98]">üö™</button>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="hidden fixed top-4 left-0 right-0 z-50">
      <div class="max-w-md mx-auto px-4">
        <div class="rounded-3xl bg-white shadow-lg border border-slate-100 p-4">
          <div class="flex items-start gap-3">
            <div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-amber-300 to-rose-300 flex items-center justify-center">üîî</div>
            <div class="flex-1">
              <div class="font-black" id="toastTitle">Novedades</div>
              <div class="text-sm text-slate-600 mt-0.5" id="toastBody"></div>
              <button id="toastOk" class="mt-3 w-full px-4 py-2 rounded-2xl bg-slate-900 text-white font-extrabold active:scale-[0.98]">Vale</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Day modal -->
    <div id="dayModal" class="hidden fixed inset-0 z-40">
      <div class="absolute inset-0 bg-black/40"></div>
      <div class="absolute inset-0 flex items-end">
        <div class="w-full max-w-md mx-auto bg-white rounded-t-[2rem] p-4 pb-6 shadow-2xl">
          <div class="flex items-center justify-between">
            <div><div id="dayModalTitle" class="text-lg font-black"></div></div>
            <button id="btnCloseDayModal" class="px-3 py-2 rounded-2xl bg-white border border-slate-100 shadow-sm active:scale-[0.98]">‚úï</button>
          </div>

          <div class="mt-3 flex gap-2">
            <button id="btnAddEventForDay" class="flex-1 px-4 py-3 rounded-2xl font-extrabold bg-gradient-to-r from-rose-400 to-fuchsia-400 text-white shadow-sm active:scale-[0.98]">‚ûï Crear evento</button>
          </div>

          <div id="eventsList" class="mt-4 space-y-3 max-h-[55vh] overflow-y-auto pr-1"></div>
        </div>
      </div>
    </div>

    <!-- Event modal -->
    <div id="eventModal" class="hidden fixed inset-0 z-50">
      <div class="absolute inset-0 bg-black/40"></div>
      <div class="absolute inset-0 flex items-end">
        <div class="w-full max-w-md mx-auto bg-white rounded-t-[2rem] p-4 pb-6 shadow-2xl">
          <div class="flex items-center justify-between">
            <div>
              <div id="eventModalTitle" class="text-lg font-black">Nuevo evento</div>
              <div id="eventModalDate" class="text-xs text-slate-500 -mt-0.5"></div>
            </div>
            <button id="btnCloseEventModal" class="px-3 py-2 rounded-2xl bg-white border border-slate-100 shadow-sm active:scale-[0.98]">‚úï</button>
          </div>

          <div class="mt-3 space-y-3">
            <div>
              <label class="text-xs font-extrabold text-slate-600">T√≠tulo</label>
              <input id="evTitle" class="mt-1 w-full px-4 py-3 rounded-2xl bg-white border border-slate-100 shadow-sm outline-none focus:ring-2 focus:ring-rose-200" placeholder="Cena en casa de..." />
            </div>

            <div class="grid grid-cols-2 gap-2">
              <div>
                <label class="text-xs font-extrabold text-slate-600">Inicio</label>
                <input id="evStart" type="time" class="mt-1 w-full px-4 py-3 rounded-2xl bg-white border border-slate-100 shadow-sm outline-none focus:ring-2 focus:ring-rose-200" />
              </div>
              <div>
                <label class="text-xs font-extrabold text-slate-600">Fin</label>
                <input id="evEnd" type="time" class="mt-1 w-full px-4 py-3 rounded-2xl bg-white border border-slate-100 shadow-sm outline-none focus:ring-2 focus:ring-rose-200" />
              </div>
            </div>

            <div>
              <label class="text-xs font-extrabold text-slate-600">Descripci√≥n</label>
              <textarea id="evDesc" rows="3" class="mt-1 w-full px-4 py-3 rounded-2xl bg-white border border-slate-100 shadow-sm outline-none focus:ring-2 focus:ring-rose-200" placeholder="Dress code, sitio, ideas..."></textarea>
            </div>

            <div class="rounded-3xl bg-rose-50 border border-rose-100 p-4">
              <div class="text-sm font-black mb-2">Estilo</div>

              <div class="grid grid-cols-3 gap-2">
                <div>
                  <label class="text-[11px] font-extrabold text-slate-600">Fondo</label>
                  <input id="evBg" type="color" class="mt-1 w-full h-12 rounded-2xl border border-white shadow-sm" />
                </div>
                <div>
                  <label class="text-[11px] font-extrabold text-slate-600">Texto</label>
                  <input id="evText" type="color" class="mt-1 w-full h-12 rounded-2xl border border-white shadow-sm" />
                </div>
                <div>
                  <label class="text-[11px] font-extrabold text-slate-600">Fuente</label>
                  <select id="evFont" class="mt-1 w-full h-12 px-3 rounded-2xl border border-white shadow-sm bg-white">
                    <option value="font-nunito">Nunito</option>
                    <option value="font-poppins">Poppins</option>
                    <option value="font-pacifico">Pacifico</option>
                  </select>
                </div>
              </div>

              <div class="mt-3">
                <div class="text-[11px] text-slate-500 mb-1">Vista previa</div>
                <div id="evPreview" class="rounded-2xl px-4 py-3 shadow-sm border border-white/80">20:00 ¬∑ Fiesta</div>
              </div>
            </div>

            <div id="eventError" class="hidden rounded-2xl bg-red-50 border border-red-100 p-3 text-sm font-bold text-red-700"></div>

            <button id="btnSaveEvent" class="w-full px-4 py-3 rounded-2xl font-extrabold bg-slate-900 text-white shadow-sm active:scale-[0.98]">Guardar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings -->
    <div id="settingsModal" class="hidden fixed inset-0 z-50">
      <div class="absolute inset-0 bg-black/40"></div>
      <div class="absolute inset-0 flex items-end">
        <div class="w-full max-w-md mx-auto bg-white rounded-t-[2rem] p-4 pb-6 shadow-2xl">
          <div class="flex items-center justify-between">
            <div class="text-lg font-black">Perfil</div>
            <button id="btnCloseSettings" class="px-3 py-2 rounded-2xl bg-white border border-slate-100 shadow-sm active:scale-[0.98]">‚úï</button>
          </div>

          <div class="mt-3 space-y-4 max-h-[70vh] overflow-y-auto pr-1">
            <div class="rounded-3xl bg-rose-50 border border-rose-100 p-4">
              <div class="flex items-center gap-3">
                <div id="meAvatarBig" class="w-14 h-14 rounded-3xl bg-white shadow-sm border border-white overflow-hidden flex items-center justify-center text-xl">üôÇ</div>
                <div class="flex-1">
                  <div id="meNameBig" class="text-base font-black"></div>
                  <div id="meUserBig" class="text-xs text-slate-500 -mt-0.5"></div>
                </div>
              </div>

              <div class="mt-3 grid grid-cols-2 gap-2">
                <button id="btnChangeAvatar" class="px-4 py-3 rounded-2xl bg-white border border-slate-100 shadow-sm font-extrabold active:scale-[0.98]">üñºÔ∏è Avatar</button>
                <button id="btnChangeName" class="px-4 py-3 rounded-2xl bg-white border border-slate-100 shadow-sm font-extrabold active:scale-[0.98]">‚úçÔ∏è Nombre</button>
              </div>
              <input id="avatarPicker" type="file" accept="image/*" class="hidden" />
            </div>

            <div id="adminPanel" class="hidden rounded-3xl bg-amber-50 border border-amber-100 p-4">
              <div class="font-black">Admin</div>
              <div id="adminUsersList" class="mt-3 space-y-2"></div>
            </div>

          </div>
        </div>
      </div>
    </div>

  </div>

<script>
/* =========================================================
   1) FORZAR HTTPS (cuando est√© publicado)
========================================================= */
(function forceHttps(){
  const isLocal = location.hostname === "localhost" || location.hostname === "127.0.0.1";
  if (!isLocal && location.protocol !== "https:") {
    location.replace("https://" + location.host + location.pathname + location.search + location.hash);
  }
})();

/* =========================================================
   2) SUPABASE CONFIG (RELLENA ESTO)
========================================================= */
const SUPABASE_URL = https://xqblvvckoxwjsezcsjnc.supabase.co
const SUPABASE_ANON_KEY = sb_publishable_yfkbeD0fV6Cv3MckgV17Lg_klduQ6ox

/* =========================================================
   APP CONFIG
========================================================= */
const APP_RANGE = { start: { y: 2025, m: 11 }, monthsCount: 13 }; // Dec 2025..Dec 2026
const FIRST_DAY_ISO = "2025-12-01";
const SUPER_ADMIN_EVENT_TITLE = "HOLA";
const LS_KEY_SEEN_PREFIX = "hep_seen_";

/* =========================================================
   SUPABASE INIT
========================================================= */
let supa = null;
if (window.supabase?.createClient && SUPABASE_URL.startsWith("http")) {
  supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
}

/* =========================================================
   STATE
========================================================= */
let session = null;
let meProfile = null;
let adminUid = null;

let monthIndex = 0;
let selectedDayISO = null;
let editingEventId = null;

const cache = {
  eventsById: new Map(),
  eventsByDate: new Map(),
  notesByEvent: new Map(),
  profilesById: new Map(),
  loadedMonthKey: new Set(),
};

let realtimeChannel = null;

/* =========================================================
   DOM
========================================================= */
const $ = (id) => document.getElementById(id);

const authView = $("authView");
const appView = $("appView");
const bottomBar = $("bottomBar");

const tabLogin = $("tabLogin");
const tabRegister = $("tabRegister");
const registerExtras = $("registerExtras");
const btnAuthAction = $("btnAuthAction");
const authError = $("authError");
const authUsername = $("authUsername");
const authPassword = $("authPassword");
const authDisplayName = $("authDisplayName");
const authAvatar = $("authAvatar");

const btnSettings = $("btnSettings");
const settingsModal = $("settingsModal");
const btnCloseSettings = $("btnCloseSettings");

const meAvatarMini = $("meAvatarMini");
const meNameMini = $("meNameMini");
const meAvatarBig = $("meAvatarBig");
const meNameBig = $("meNameBig");
const meUserBig = $("meUserBig");

const btnLogout = $("btnLogout");
const btnQuickAdd = $("btnQuickAdd");

const monthTitle = $("monthTitle");
const calendarGrid = $("calendarGrid");
const btnPrevMonth = $("btnPrevMonth");
const btnNextMonth = $("btnNextMonth");
const btnToday = $("btnToday");
const adminBadge = $("adminBadge");

const dayModal = $("dayModal");
const btnCloseDayModal = $("btnCloseDayModal");
const dayModalTitle = $("dayModalTitle");
const btnAddEventForDay = $("btnAddEventForDay");
const eventsList = $("eventsList");

const eventModal = $("eventModal");
const btnCloseEventModal = $("btnCloseEventModal");
const eventModalTitle = $("eventModalTitle");
const eventModalDate = $("eventModalDate");
const evTitle = $("evTitle");
const evStart = $("evStart");
const evEnd = $("evEnd");
const evDesc = $("evDesc");
const evBg = $("evBg");
const evText = $("evText");
const evFont = $("evFont");
const evPreview = $("evPreview");
const eventError = $("eventError");
const btnSaveEvent = $("btnSaveEvent");

const toast = $("toast");
const toastTitle = $("toastTitle");
const toastBody = $("toastBody");
const toastOk = $("toastOk");

const btnOpenProfile = $("btnOpenProfile");
const btnChangeAvatar = $("btnChangeAvatar");
const btnChangeName = $("btnChangeName");
const avatarPicker = $("avatarPicker");

const adminPanel = $("adminPanel");
const adminUsersList = $("adminUsersList");

/* =========================================================
   INIT
========================================================= */
let authMode = "login";
setAuthTab("login");
wireUI();
bootstrap();

/* =========================================================
   UI
========================================================= */
function wireUI() {
  tabLogin.addEventListener("click", () => setAuthTab("login"));
  tabRegister.addEventListener("click", () => setAuthTab("register"));

  btnAuthAction.addEventListener("click", async () => {
    clearAuthError();
    if (!supa) return showAuthError("Falta configurar Supabase URL y ANON KEY en el c√≥digo.");

    const username = (authUsername.value || "").trim();
    const password = authPassword.value || "";
    if (!username || !password) return showAuthError("Escribe usuaria y contrase√±a.");

    if (authMode === "register") {
      const displayName = (authDisplayName.value || "").trim() || username;
      const avatarData = await fileToDataURL(authAvatar.files?.[0] || null);
      await doRegister(username, password, displayName, avatarData);
    } else {
      await doLogin(username, password);
    }
  });

  btnSettings.addEventListener("click", openSettings);
  btnCloseSettings.addEventListener("click", closeSettings);

  btnLogout.addEventListener("click", logout);

  btnQuickAdd.addEventListener("click", () => {
    const todayISO = clampToRange(toISODate(new Date()));
    openDayModal(todayISO);
    openEventModal(todayISO, null);
  });

  btnPrevMonth.addEventListener("click", async () => {
    monthIndex = Math.max(0, monthIndex - 1);
    await renderCalendar();
  });
  btnNextMonth.addEventListener("click", async () => {
    monthIndex = Math.min(APP_RANGE.monthsCount - 1, monthIndex + 1);
    await renderCalendar();
  });

  btnToday.addEventListener("click", async () => {
    const todayISO = clampToRange(toISODate(new Date()));
    const idx = monthIndexFromISO(todayISO);
    if (idx !== null) monthIndex = idx;
    await renderCalendar();
  });

  btnCloseDayModal.addEventListener("click", closeDayModal);
  dayModal.addEventListener("click", (e) => { if (e.target === dayModal) closeDayModal(); });
  btnAddEventForDay.addEventListener("click", () => openEventModal(selectedDayISO, null));

  btnCloseEventModal.addEventListener("click", closeEventModal);
  eventModal.addEventListener("click", (e) => { if (e.target === eventModal) closeEventModal(); });

  [evTitle, evStart, evEnd, evBg, evText, evFont].forEach(el => el.addEventListener("input", updateEventPreview));
  btnSaveEvent.addEventListener("click", saveEventFromModal);

  toastOk.addEventListener("click", () => {
    toast.classList.add("hidden");
    markSeenNow();
  });

  btnOpenProfile.addEventListener("click", openSettings);

  btnChangeAvatar.addEventListener("click", () => avatarPicker.click());
  avatarPicker.addEventListener("change", async () => {
    const data = await fileToDataURL(avatarPicker.files?.[0] || null);
    if (!data) return;
    await supa.from("profiles").update({ avatar_data: data, updated_at: new Date().toISOString() }).eq("user_id", session.user.id);
    await loadMyProfile();
    renderMe();
    toastMini("Avatar actualizado");
  });

  btnChangeName.addEventListener("click", async () => {
    const next = prompt("Nuevo nombre:", meProfile?.display_name || meProfile?.username || "");
    if (!next) return;
    await supa.from("profiles").update({ display_name: next.trim().slice(0, 40), updated_at: new Date().toISOString() }).eq("user_id", session.user.id);
    await loadMyProfile();
    renderMe();
    toastMini("Nombre actualizado");
  });
}

function setAuthTab(mode) {
  authMode = mode;
  if (mode === "login") {
    tabLogin.className = "px-3 py-2 rounded-2xl font-extrabold bg-gradient-to-r from-rose-400 to-fuchsia-400 text-white shadow-sm active:scale-[0.98]";
    tabRegister.className = "px-3 py-2 rounded-2xl font-extrabold bg-white border border-slate-100 shadow-sm active:scale-[0.98]";
    registerExtras.classList.add("hidden");
    btnAuthAction.textContent = "Entrar";
  } else {
    tabRegister.className = "px-3 py-2 rounded-2xl font-extrabold bg-gradient-to-r from-rose-400 to-fuchsia-400 text-white shadow-sm active:scale-[0.98]";
    tabLogin.className = "px-3 py-2 rounded-2xl font-extrabold bg-white border border-slate-100 shadow-sm active:scale-[0.98]";
    registerExtras.classList.remove("hidden");
    btnAuthAction.textContent = "Crear cuenta";
  }
}
function showAuthError(msg) { authError.textContent = msg; authError.classList.remove("hidden"); }
function clearAuthError() { authError.classList.add("hidden"); authError.textContent = ""; }

function usernameToEmail(username) {
  const safe = normalize(username).replace(/[^a-z0-9._-]/g,"").slice(0,40) || "user";
  return `${safe}@hasta.local`;
}

/* =========================================================
   AUTH (Supabase)
========================================================= */
async function doRegister(username, password, displayName, avatarData) {
  const email = usernameToEmail(username);

  // Si tienes confirmaci√≥n de email activada, NO funcionar√° con emails ‚Äúfake‚Äù.
  // Recomendado: desactivar email confirmations en Supabase Auth.
  const { data, error } = await supa.auth.signUp({
    email,
    password,
    options: { emailRedirectTo: location.origin }
  });

  if (error) return showAuthError(error.message || "Error registro.");
  session = data.session;

  if (!session) {
    return showAuthError("Registro creado, pero tu Supabase est√° pidiendo confirmaci√≥n de email. Desact√≠valo (pasos abajo).");
  }

  await supa.from("profiles").upsert({
    user_id: session.user.id,
    username,
    display_name: displayName,
    avatar_data: avatarData || null,
    disabled: false,
    updated_at: new Date().toISOString()
  });

  await afterLogin();
}

async function doLogin(username, password) {
  const email = usernameToEmail(username);

  const { data, error } = await supa.auth.signInWithPassword({ email, password });
  if (error) return showAuthError("Usuaria o contrase√±a incorrectas.");
  session = data.session;
  await afterLogin();
}

async function logout() {
  try { if (realtimeChannel) supa.removeChannel(realtimeChannel); } catch(e) {}
  realtimeChannel = null;

  cache.loadedMonthKey.clear();
  cache.eventsById.clear();
  cache.eventsByDate.clear();
  cache.notesByEvent.clear();
  cache.profilesById.clear();
  meProfile = null;
  adminUid = null;

  await supa.auth.signOut();
  session = null;
  renderAuth();
}

/* =========================================================
   BOOTSTRAP
========================================================= */
async function bootstrap() {
  renderAuth();
  if (!supa) return;

  const { data } = await supa.auth.getSession();
  session = data?.session || null;

  supa.auth.onAuthStateChange((_event, newSession) => { session = newSession; });

  if (session) await afterLogin();
}

async function afterLogin() {
  await loadMyProfile();
  if (meProfile?.disabled) {
    await supa.auth.signOut();
    session = null;
    renderAuth();
    return showAuthError("Tu cuenta est√° desactivada.");
  }

  renderApp();

  const todayISO = toISODate(new Date());
  const idx = monthIndexFromISO(todayISO);
  monthIndex = idx !== null ? idx : 0;

  await refreshAdminUid();
  await renderCalendar();
  await setupRealtime();
  await showNewStuffPopup();
}

/* =========================================================
   PROFILE / ADMIN
========================================================= */
async function loadMyProfile() {
  const uid = session.user.id;
  const { data } = await supa.from("profiles").select("*").eq("user_id", uid).maybeSingle();

  if (!data) {
    await supa.from("profiles").insert({
      user_id: uid,
      username: "user",
      display_name: "user",
      disabled: false,
      updated_at: new Date().toISOString()
    });
    const again = await supa.from("profiles").select("*").eq("user_id", uid).maybeSingle();
    meProfile = again.data;
  } else {
    meProfile = data;
  }
  cache.profilesById.set(uid, meProfile);
}

async function refreshAdminUid() {
  const { data } = await supa
    .from("events")
    .select("created_by")
    .eq("date", FIRST_DAY_ISO)
    .ilike("title", SUPER_ADMIN_EVENT_TITLE)
    .order("created_at", { ascending: true })
    .limit(1);

  adminUid = Array.isArray(data) && data.length ? data[0].created_by : null;
  adminBadge.classList.toggle("hidden", !isAdmin());
}

function isAdmin() {
  return !!adminUid && session?.user?.id === adminUid;
}

/* =========================================================
   RENDER VIEWS
========================================================= */
function renderAuth() {
  authView.classList.remove("hidden");
  appView.classList.add("hidden");
  bottomBar.classList.add("hidden");
  btnSettings.classList.add("hidden");

  authUsername.value = "";
  authPassword.value = "";
  authDisplayName.value = "";
  authAvatar.value = "";
  clearAuthError();
}

function renderApp() {
  authView.classList.add("hidden");
  appView.classList.remove("hidden");
  bottomBar.classList.remove("hidden");
  btnSettings.classList.remove("hidden");
  renderMe();
}

function renderMe() {
  const name = meProfile?.display_name || meProfile?.username || "Yo";
  meNameMini.textContent = name;

  if (meProfile?.avatar_data) {
    meAvatarMini.innerHTML = `<img src="${meProfile.avatar_data}" class="w-full h-full object-cover" />`;
    meAvatarBig.innerHTML = `<img src="${meProfile.avatar_data}" class="w-full h-full object-cover" />`;
  } else {
    meAvatarMini.textContent = "üôÇ";
    meAvatarBig.textContent = "üôÇ";
  }
  meNameBig.textContent = name;
  meUserBig.textContent = meProfile?.username ? `@${meProfile.username}` : "";
  adminBadge.classList.toggle("hidden", !isAdmin());
}

/* =========================================================
   DATA LOAD
========================================================= */
async function ensureMonthLoaded(ym) {
  const key = `${ym.y}-${String(ym.m+1).padStart(2,"0")}`;
  if (cache.loadedMonthKey.has(key)) return;

  const start = new Date(ym.y, ym.m, 1);
  const end = new Date(ym.y, ym.m + 1, 0);

  const startISO = toISODate(start);
  const endISO = toISODate(end);

  const { data, error } = await supa
    .from("events")
    .select("*")
    .gte("date", startISO)
    .lte("date", endISO);

  if (error) { toastMini("Error cargando eventos"); return; }

  for (const r of (data || [])) upsertEventInCache(r);

  cache.loadedMonthKey.add(key);
}

function upsertEventInCache(r) {
  const ev = {
    id: r.id,
    date: r.date,
    title: r.title,
    start: (r.start_time || "").slice(0,5),
    end: (r.end_time || "").slice(0,5),
    description: r.description || "",
    style: { bg: r.bg_color || "#ffe4f1", text: r.text_color || "#111827", font: r.font || "font-nunito" },
    createdBy: r.created_by,
    createdAt: r.created_at ? Date.parse(r.created_at) : Date.now(),
    updatedAt: r.updated_at ? Date.parse(r.updated_at) : Date.now()
  };

  cache.eventsById.set(ev.id, ev);
  if (!cache.eventsByDate.has(ev.date)) cache.eventsByDate.set(ev.date, []);
  const arr = cache.eventsByDate.get(ev.date);
  if (!arr.includes(ev.id)) arr.push(ev.id);
}

function removeEventFromCache(eventId) {
  const ev = cache.eventsById.get(eventId);
  if (!ev) return;
  cache.eventsById.delete(eventId);

  const arr = cache.eventsByDate.get(ev.date) || [];
  cache.eventsByDate.set(ev.date, arr.filter(id => id !== eventId));
  cache.notesByEvent.delete(eventId);
}

/* =========================================================
   CALENDAR
========================================================= */
async function renderCalendar() {
  const ym = monthFromIndex(monthIndex);
  const monthName = new Intl.DateTimeFormat("es-ES", { month: "long", year: "numeric" }).format(new Date(ym.y, ym.m, 1));
  monthTitle.textContent = capitalize(monthName);

  await ensureMonthLoaded(ym);

  const start = gridStartMonday(ym.y, ym.m);
  calendarGrid.innerHTML = "";

  const nowISO = toISODate(new Date());

  for (let i = 0; i < 42; i++) {
    const d = addDays(start, i);
    const iso = toISODate(d);
    const inMonth = (d.getMonth() === ym.m);
    const clamped = isInRangeISO(iso);
    const dayNum = d.getDate();

    const dayEvents = getEventsForDate(iso).sort((a,b)=> (a.start||"").localeCompare(b.start||""));
    const preview = dayEvents.slice(0,2).map(ev => {
      const t = (ev.start || "").slice(0,5);
      const title = (ev.title || "").slice(0,18);
      const bg = ev.style?.bg || "#ffe4f1";
      const tx = ev.style?.text || "#1f2937";
      return `
        <div class="mt-1 px-1.5 py-1 rounded-xl text-[10px] font-extrabold truncate shadow-sm border border-white/70"
             style="background:${bg};color:${tx}">
          ${t ? `${t} ¬∑ ` : ""}${escapeHtml(title)}
        </div>`;
    }).join("");

    const more = dayEvents.length > 2
      ? `<div class="mt-1 text-[10px] font-extrabold text-slate-400 text-center">+${dayEvents.length-2}</div>`
      : "";

    const btn = document.createElement("button");
    btn.className =
      "relative rounded-2xl p-2 h-[76px] overflow-hidden border shadow-sm active:scale-[0.98] transition " +
      (inMonth ? "bg-white/90 border-white/70" : "bg-white/50 border-white/50") +
      (iso === nowISO ? " ring-2 ring-rose-300" : "");

    if (!clamped) {
      btn.className += " opacity-40";
      btn.disabled = true;
    } else {
      btn.addEventListener("click", () => openDayModal(iso));
    }

    btn.innerHTML = `
      <div class="flex items-start justify-between">
        <div class="text-sm font-black ${inMonth ? "text-slate-800" : "text-slate-400"}">${dayNum}</div>
        <div class="text-[10px]">${isWeekend(d) ? "üéâ" : ""}</div>
      </div>
      <div>${preview}${more}</div>
    `;

    calendarGrid.appendChild(btn);
  }

  adminBadge.classList.toggle("hidden", !isAdmin());
}

/* =========================================================
   DAY MODAL
========================================================= */
async function openDayModal(iso) {
  selectedDayISO = iso;
  dayModal.classList.remove("hidden");

  const d = parseISODate(iso);
  dayModalTitle.textContent = new Intl.DateTimeFormat("es-ES", { weekday: "long", day: "numeric", month: "long", year: "numeric" }).format(d);

  await renderDayEvents();
}
function closeDayModal() {
  dayModal.classList.add("hidden");
  selectedDayISO = null;
}

function getEventsForDate(dateISO) {
  const ids = cache.eventsByDate.get(dateISO) || [];
  return ids.map(id => cache.eventsById.get(id)).filter(Boolean);
}

async function renderDayEvents() {
  const list = getEventsForDate(selectedDayISO).sort((a,b)=> (a.start||"").localeCompare(b.start||""));

  if (!list.length) {
    eventsList.innerHTML = `
      <div class="rounded-3xl bg-slate-50 border border-slate-100 p-4 text-slate-600">
        <div class="font-black">No hay eventos</div>
      </div>
    `;
    return;
  }

  await loadNotesForEvents(list.map(e => e.id));
  await ensureProfiles(list.map(e => e.createdBy));

  eventsList.innerHTML = list.map(ev => renderEventCard(ev)).join("");

  list.forEach(ev => {
    const editBtn = document.querySelector(`[data-ev-edit="${ev.id}"]`);
    const delBtn = document.querySelector(`[data-ev-del="${ev.id}"]`);
    const addNoteBtn = document.querySelector(`[data-note-add="${ev.id}"]`);
    const noteInput = document.querySelector(`[data-note-input="${ev.id}"]`);

    if (editBtn) editBtn.addEventListener("click", () => openEventModal(ev.date, ev.id));
    if (delBtn) delBtn.addEventListener("click", () => deleteEvent(ev.id));
    if (addNoteBtn) addNoteBtn.addEventListener("click", () => addNote(ev.id, noteInput));

    const noteEditBtns = document.querySelectorAll(`[data-note-edit-for="${ev.id}"]`);
    noteEditBtns.forEach(btn => btn.addEventListener("click", () => openEditNote(btn.getAttribute("data-note-edit"))));

    const noteDelBtns = document.querySelectorAll(`[data-note-del-for="${ev.id}"]`);
    noteDelBtns.forEach(btn => btn.addEventListener("click", () => deleteNote(btn.getAttribute("data-note-del"))));
  });
}

function canEditBy(uid) {
  return isAdmin() || uid === session.user.id;
}

function renderEventCard(ev) {
  const creator = cache.profilesById.get(ev.createdBy);
  const creatorName = creator ? (creator.display_name || creator.username) : "Desconocida";

  const meCanEdit = canEditBy(ev.createdBy);

  const bg = ev.style?.bg || "#ffe4f1";
  const tx = ev.style?.text || "#111827";
  const fontClass = ev.style?.font || "font-nunito";

  const notes = cache.notesByEvent.get(ev.id) || [];
  const notesHtml = notes.length
    ? notes.map(n => renderNoteRow(n, bg, tx, fontClass)).join("")
    : `<div class="text-xs text-slate-500 mt-2">Sin notas</div>`;

  return `
    <div class="rounded-3xl border border-white/70 shadow-sm overflow-hidden">
      <div class="p-4 ${fontClass}" style="background:${bg};color:${tx}">
        <div class="flex items-start justify-between gap-3">
          <div class="min-w-0">
            <div class="text-lg font-black leading-tight truncate">
              ${(ev.start||"").slice(0,5)}${ev.start ? " ¬∑ " : ""}${escapeHtml(ev.title || "(sin t√≠tulo)")}
            </div>
            <div class="text-xs opacity-80 mt-0.5">
              ${(ev.start||"").slice(0,5)} ‚Üí ${(ev.end||"").slice(0,5)} ¬∑ <b>${escapeHtml(creatorName)}</b>
            </div>
            ${ev.description ? `<div class="text-sm mt-2 opacity-90">${escapeHtml(ev.description)}</div>` : ""}
          </div>

          <div class="shrink-0 flex flex-col gap-2">
            ${meCanEdit ? `<button data-ev-edit="${ev.id}" class="px-3 py-2 rounded-2xl bg-white/90 text-slate-900 font-extrabold shadow-sm border border-white/70 active:scale-[0.98]">‚úèÔ∏è</button>` : ""}
            ${meCanEdit ? `<button data-ev-del="${ev.id}" class="px-3 py-2 rounded-2xl bg-white/90 text-slate-900 font-extrabold shadow-sm border border-white/70 active:scale-[0.98]">üóëÔ∏è</button>` : ""}
          </div>
        </div>

        <div class="mt-3 rounded-3xl bg-white/70 border border-white/70 p-3">
          <div class="flex items-center justify-between">
            <div class="text-sm font-black">Notas</div>
            <div class="text-xs opacity-70">${notes.length}</div>
          </div>

          <div class="mt-2 space-y-2">${notesHtml}</div>

          <div class="mt-3 flex gap-2">
            <input data-note-input="${ev.id}" class="flex-1 px-4 py-3 rounded-2xl bg-white border border-white/70 shadow-sm outline-none" placeholder="Escribe una nota..." />
            <button data-note-add="${ev.id}" class="px-4 py-3 rounded-2xl bg-slate-900 text-white font-extrabold shadow-sm active:scale-[0.98]">‚ûï</button>
          </div>
        </div>
      </div>
    </div>
  `;
}

function renderNoteRow(note, bg, tx, fontClass) {
  const author = cache.profilesById.get(note.createdBy);
  const authorName = author ? (author.display_name || author.username) : "Desconocida";
  const meCanEdit = canEditBy(note.createdBy);

  return `
    <div class="rounded-2xl px-3 py-2 border border-white/80 shadow-sm ${fontClass}" style="background:${bg};color:${tx}">
      <div class="flex items-start justify-between gap-2">
        <div class="min-w-0">
          <div class="text-xs opacity-80"><b>${escapeHtml(authorName)}</b></div>
          <div class="text-sm font-semibold break-words">${escapeHtml(note.text)}</div>
        </div>
        <div class="shrink-0 flex gap-1">
          ${meCanEdit ? `<button data-note-edit-for="${note.eventId}" data-note-edit="${note.id}" class="px-2 py-1 rounded-xl bg-white/90 text-slate-900 font-extrabold border border-white/70 active:scale-[0.98]">‚úèÔ∏è</button>` : ""}
          ${meCanEdit ? `<button data-note-del-for="${note.eventId}" data-note-del="${note.id}" class="px-2 py-1 rounded-xl bg-white/90 text-slate-900 font-extrabold border border-white/70 active:scale-[0.98]">üóëÔ∏è</button>` : ""}
        </div>
      </div>
    </div>
  `;
}

/* =========================================================
   EVENT MODAL
========================================================= */
function openEventModal(dayISO, eventId) {
  editingEventId = eventId;
  const d = parseISODate(dayISO);
  eventModalDate.textContent = new Intl.DateTimeFormat("es-ES", { day: "numeric", month: "long", year: "numeric" }).format(d);

  if (!eventId) {
    eventModalTitle.textContent = "Nuevo evento";
    evTitle.value = "";
    evStart.value = "20:00";
    evEnd.value = "23:00";
    evDesc.value = "";
    evBg.value = "#ffe4f1";
    evText.value = "#111827";
    evFont.value = "font-nunito";
  } else {
    const ev = cache.eventsById.get(eventId);
    if (!ev) return;
    if (!canEditBy(ev.createdBy)) return toastMini("No puedes editar este evento");

    eventModalTitle.textContent = "Editar evento";
    evTitle.value = ev.title || "";
    evStart.value = ev.start || "20:00";
    evEnd.value = ev.end || "23:00";
    evDesc.value = ev.description || "";
    evBg.value = ev.style?.bg || "#ffe4f1";
    evText.value = ev.style?.text || "#111827";
    evFont.value = ev.style?.font || "font-nunito";
  }

  updateEventPreview();
  clearEventError();
  eventModal.classList.remove("hidden");
  selectedDayISO = dayISO;
}

function closeEventModal() {
  eventModal.classList.add("hidden");
  editingEventId = null;
  clearEventError();
}

function updateEventPreview() {
  const t = (evStart.value || "20:00").slice(0,5);
  const title = evTitle.value || "Fiesta";
  const bg = evBg.value || "#ffe4f1";
  const tx = evText.value || "#111827";
  const font = evFont.value || "font-nunito";

  evPreview.className = `rounded-2xl px-4 py-3 shadow-sm border border-white/80 ${font}`;
  evPreview.style.background = bg;
  evPreview.style.color = tx;
  evPreview.textContent = `${t} ¬∑ ${title}`;
}

function showEventError(msg) { eventError.textContent = msg; eventError.classList.remove("hidden"); }
function clearEventError() { eventError.classList.add("hidden"); eventError.textContent = ""; }

async function saveEventFromModal() {
  clearEventError();

  const title = (evTitle.value || "").trim();
  const start = evStart.value || "";
  const end = evEnd.value || "";
  const desc = (evDesc.value || "").trim();

  if (!title) return showEventError("Pon un t√≠tulo.");
  if (!start || !end) return showEventError("Define inicio y fin.");
  if (end <= start) return showEventError("Fin debe ser mayor que inicio.");

  const payload = {
    date: selectedDayISO,
    title,
    start_time: start,
    end_time: end,
    description: desc,
    bg_color: evBg.value || "#ffe4f1",
    text_color: evText.value || "#111827",
    font: evFont.value || "font-nunito",
    updated_at: new Date().toISOString()
  };

  if (!editingEventId) {
    const id = crypto.randomUUID();
    const ins = { id, ...payload, created_by: session.user.id };

    const { data, error } = await supa.from("events").insert(ins).select("*").single();
    if (error) return showEventError("No se pudo guardar.");

    upsertEventInCache(data);
    await refreshAdminUid();
    toastMini("Evento creado");
  } else {
    const ev = cache.eventsById.get(editingEventId);
    if (!ev) return showEventError("Evento no encontrado.");
    if (!canEditBy(ev.createdBy)) return showEventError("No puedes editar este evento.");

    const { data, error } = await supa.from("events").update(payload).eq("id", editingEventId).select("*").single();
    if (error) return showEventError("No se pudo actualizar.");

    upsertEventInCache(data);
    await refreshAdminUid();
    toastMini("Evento actualizado");
  }

  closeEventModal();
  await renderCalendar();
  await renderDayEvents();
}

async function deleteEvent(eventId) {
  const ev = cache.eventsById.get(eventId);
  if (!ev) return;
  if (!canEditBy(ev.createdBy)) return toastMini("No puedes borrar este evento");
  if (!confirm("¬øBorrar este evento y sus notas?")) return;

  await supa.from("notes").delete().eq("event_id", eventId);
  const { error } = await supa.from("events").delete().eq("id", eventId);
  if (error) return toastMini("No se pudo borrar");

  removeEventFromCache(eventId);
  await refreshAdminUid();
  toastMini("Evento borrado");
  await renderCalendar();
  await renderDayEvents();
}

/* =========================================================
   NOTES
========================================================= */
async function loadNotesForEvents(eventIds) {
  const need = eventIds.filter(id => !cache.notesByEvent.has(id));
  if (!need.length) return;

  const { data, error } = await supa.from("notes").select("*").in("event_id", need);
  if (error) return;

  const byEvent = new Map();
  for (const r of (data || [])) {
    const n = {
      id: r.id,
      eventId: r.event_id,
      text: r.text,
      createdBy: r.created_by,
      createdAt: r.created_at ? Date.parse(r.created_at) : Date.now(),
      updatedAt: r.updated_at ? Date.parse(r.updated_at) : Date.now()
    };
    if (!byEvent.has(n.eventId)) byEvent.set(n.eventId, []);
    byEvent.get(n.eventId).push(n);
  }

  for (const id of need) cache.notesByEvent.set(id, (byEvent.get(id) || []).sort((a,b)=>a.createdAt-b.createdAt));

  const allAuthors = [];
  for (const arr of byEvent.values()) for (const n of arr) allAuthors.push(n.createdBy);
  await ensureProfiles(allAuthors);
}

async function ensureProfiles(userIds) {
  const uniq = [...new Set(userIds.filter(Boolean))];
  const missing = uniq.filter(uid => !cache.profilesById.has(uid));
  if (!missing.length) return;

  const { data } = await supa.from("profiles").select("user_id,username,display_name,avatar_data,disabled").in("user_id", missing);
  for (const p of (data || [])) cache.profilesById.set(p.user_id, p);
}

async function addNote(eventId, inputEl) {
  const text = (inputEl?.value || "").trim();
  if (!text) return;

  const id = crypto.randomUUID();
  const ins = { id, event_id: eventId, text, created_by: session.user.id, updated_at: new Date().toISOString() };

  const { error } = await supa.from("notes").insert(ins);
  if (error) return toastMini("No se pudo a√±adir");

  cache.notesByEvent.delete(eventId);
  inputEl.value = "";
  toastMini("Nota a√±adida");
  await renderDayEvents();
}

function findNote(eventId, noteId) {
  const arr = cache.notesByEvent.get(eventId) || [];
  return arr.find(n => n.id === noteId) || null;
}

async function openEditNote(noteId) {
  const events = getEventsForDate(selectedDayISO);
  for (const ev of events) {
    const n = findNote(ev.id, noteId);
    if (!n) continue;
    if (!canEditBy(n.createdBy)) return toastMini("No puedes editar esta nota");

    const next = prompt("Editar nota:", n.text);
    if (next === null) return;

    const { error } = await supa.from("notes").update({ text: next.trim(), updated_at: new Date().toISOString() }).eq("id", n.id);
    if (error) return toastMini("No se pudo actualizar");

    cache.notesByEvent.delete(ev.id);
    toastMini("Nota actualizada");
    await renderDayEvents();
    return;
  }
}

async function deleteNote(noteId) {
  const events = getEventsForDate(selectedDayISO);
  for (const ev of events) {
    const n = findNote(ev.id, noteId);
    if (!n) continue;
    if (!canEditBy(n.createdBy)) return toastMini("No puedes borrar esta nota");
    if (!confirm("¬øBorrar esta nota?")) return;

    const { error } = await supa.from("notes").delete().eq("id", n.id);
    if (error) return toastMini("No se pudo borrar");

    cache.notesByEvent.delete(ev.id);
    toastMini("Nota borrada");
    await renderDayEvents();
    return;
  }
}

/* =========================================================
   SETTINGS + ADMIN (activar/desactivar)
========================================================= */
async function openSettings() {
  adminPanel.classList.toggle("hidden", !isAdmin());
  if (isAdmin()) await renderAdminUsers();
  settingsModal.classList.remove("hidden");
}
function closeSettings() { settingsModal.classList.add("hidden"); }

async function renderAdminUsers() {
  const { data, error } = await supa.from("profiles").select("user_id,username,display_name,disabled").order("display_name", { ascending: true });
  if (error) return;

  adminUsersList.innerHTML = (data || []).map(p => {
    const isMe = p.user_id === session.user.id;
    const label = escapeHtml(p.display_name || p.username || "user");
    return `
      <div class="rounded-2xl bg-white border border-amber-100 p-3 flex items-center justify-between">
        <div class="min-w-0">
          <div class="font-black truncate">${label}${isMe ? " (t√∫)" : ""}</div>
          <div class="text-xs text-slate-500 truncate">@${escapeHtml(p.username || "")}</div>
        </div>
        <button data-toggle-user="${p.user_id}" class="px-3 py-2 rounded-2xl ${p.disabled ? "bg-emerald-600" : "bg-slate-900"} text-white font-extrabold shadow-sm active:scale-[0.98]" ${isMe ? "disabled" : ""}>
          ${p.disabled ? "Activar" : "Desactivar"}
        </button>
      </div>
    `;
  }).join("");

  (data || []).forEach(p => {
    const btn = document.querySelector(`[data-toggle-user="${p.user_id}"]`);
    if (!btn || p.user_id === session.user.id) return;
    btn.addEventListener("click", async () => {
      if (!isAdmin()) return;
      const next = !p.disabled;
      const { error } = await supa.from("profiles").update({ disabled: next, updated_at: new Date().toISOString() }).eq("user_id", p.user_id);
      if (error) return toastMini("No se pudo cambiar");
      toastMini(next ? "Usuario desactivado" : "Usuario activado");
      await renderAdminUsers();
    });
  });
}

/* =========================================================
   REALTIME (Postgres Changes)
========================================================= */
async function setupRealtime() {
  try { if (realtimeChannel) supa.removeChannel(realtimeChannel); } catch(e) {}

  realtimeChannel = supa
    .channel("hep-realtime")
    .on("postgres_changes", { event: "*", schema: "public", table: "events" }, async (payload) => {
      if (payload.eventType === "DELETE") {
        const id = payload.old?.id;
        if (id) removeEventFromCache(id);
      } else {
        if (payload.new?.id) upsertEventInCache(payload.new);
      }

      const date = payload.new?.date || payload.old?.date;
      const title = payload.new?.title || payload.old?.title;
      if (date === FIRST_DAY_ISO && normalize(title) === normalize(SUPER_ADMIN_EVENT_TITLE)) await refreshAdminUid();

      await renderCalendar();
      if (!dayModal.classList.contains("hidden")) await renderDayEvents();
      const by = payload.new?.created_by || payload.old?.created_by;
      if (by && by !== session.user.id) toastMini("Sincronizado");
    })
    .on("postgres_changes", { event: "*", schema: "public", table: "notes" }, async (payload) => {
      const evId = payload.new?.event_id || payload.old?.event_id;
      if (evId) cache.notesByEvent.delete(evId);
      if (!dayModal.classList.contains("hidden")) await renderDayEvents();

      const by = payload.new?.created_by || payload.old?.created_by;
      if (by && by !== session.user.id) toastMini("Nueva nota");
    })
    .subscribe();
}

/* =========================================================
   NOVEDADES AL ENTRAR
========================================================= */
async function showNewStuffPopup() {
  const since = getLastSeen();
  if (!since) { markSeenNow(true); return; }

  const sinceISO = new Date(since).toISOString();
  const uid = session.user.id;

  let lines = [];

  const evRes = await supa.from("events").select("title,date,updated_at,created_by").gt("updated_at", sinceISO).order("updated_at", { ascending: false }).limit(5);
  (evRes.data || []).forEach(e => { if (e.created_by !== uid) lines.push(`‚Ä¢ Evento: ${e.title} (${e.date})`); });

  const nRes = await supa.from("notes").select("text,updated_at,created_by").gt("updated_at", sinceISO).order("updated_at", { ascending: false }).limit(5);
  (nRes.data || []).forEach(n => { if (n.created_by !== uid) lines.push(`‚Ä¢ Nota: ${String(n.text||"").slice(0,36)}${(String(n.text||"").length>36)?"‚Ä¶":""}`); });

  lines = lines.slice(0, 6);

  if (!lines.length) { markSeenNow(true); return; }

  toastTitle.textContent = "Novedades";
  toastBody.innerHTML = lines.map(x => escapeHtml(x)).join("<br>");
  toastOk.textContent = "Vale";
  toast.classList.remove("hidden");
}

function getLastSeen() {
  const key = LS_KEY_SEEN_PREFIX + (session?.user?.id || "");
  const v = localStorage.getItem(key);
  return v ? Number(v) : 0;
}
function markSeenNow(silent=false) {
  const key = LS_KEY_SEEN_PREFIX + (session?.user?.id || "");
  localStorage.setItem(key, String(Date.now()));
  if (!silent) toastMini("Ok");
}

function toastMini(msg) {
  if (!toast.classList.contains("hidden")) return;
  toastTitle.textContent = "‚ú®";
  toastBody.textContent = msg;
  toastOk.textContent = "Ok";
  toast.classList.remove("hidden");
  setTimeout(() => { if (!toast.classList.contains("hidden")) toast.classList.add("hidden"); }, 1200);
}

/* =========================================================
   UTILS
========================================================= */
function escapeHtml(s) {
  return String(s || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function normalize(s) { return String(s||"").trim().toLowerCase(); }

async function fileToDataURL(file) {
  if (!file) return null;
  return await new Promise((res) => {
    const reader = new FileReader();
    reader.onload = () => res(reader.result);
    reader.onerror = () => res(null);
    reader.readAsDataURL(file);
  });
}

/* Date helpers */
function monthFromIndex(idx) {
  let y = APP_RANGE.start.y, m = APP_RANGE.start.m;
  for (let i = 0; i < idx; i++) { m++; if (m > 11) { m = 0; y++; } }
  return { y, m };
}
function monthIndexFromISO(iso) {
  if (!iso) return null;
  const d = parseISODate(iso);
  const y = d.getFullYear(), m = d.getMonth();
  let yy = APP_RANGE.start.y, mm = APP_RANGE.start.m;
  for (let i = 0; i < APP_RANGE.monthsCount; i++) {
    if (yy === y && mm === m) return i;
    mm++; if (mm > 11) { mm = 0; yy++; }
  }
  return null;
}
function isInRangeISO(iso) {
  const d = parseISODate(iso);
  const start = new Date(APP_RANGE.start.y, APP_RANGE.start.m, 1);
  const end = new Date(APP_RANGE.start.y, APP_RANGE.start.m + APP_RANGE.monthsCount, 1);
  return d >= start && d < end;
}
function clampToRange(iso) {
  const d = parseISODate(iso);
  const start = new Date(APP_RANGE.start.y, APP_RANGE.start.m, 1);
  const endExclusive = new Date(APP_RANGE.start.y, APP_RANGE.start.m + APP_RANGE.monthsCount, 1);
  if (d < start) return toISODate(start);
  if (d >= endExclusive) return toISODate(addDays(endExclusive, -1));
  return iso;
}
function gridStartMonday(y, m) {
  const first = new Date(y, m, 1);
  const dow = (first.getDay() + 6) % 7;
  return new Date(y, m, 1 - dow);
}
function addDays(date, days) { const d = new Date(date); d.setDate(d.getDate()+days); return d; }
function toISODate(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function parseISODate(iso) { const [y,m,d] = iso.split("-").map(Number); return new Date(y, (m||1)-1, d||1); }
function isWeekend(d) { const gd = d.getDay(); return gd === 0 || gd === 6; }
function capitalize(s) { return (s||"").charAt(0).toUpperCase() + (s||"").slice(1); }
</script>
</body>
</html>
